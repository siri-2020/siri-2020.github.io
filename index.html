<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bill Splitter</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
        }

        .header {
            background: #fff;
            color: #333;
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 1.5em;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .header p {
            color: #666;
            font-size: 0.9em;
        }

        .content {
            padding: 20px;
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
        }

        .step-header {
            color: #333;
            font-size: 1.3em;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        input[type="text"],
        input[type="number"] {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }

        input[type="text"]:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: #007AFF;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
        }

        .btn-primary {
            background: #007AFF;
            color: white;
        }

        .btn-primary:active {
            background: #0051D5;
        }

        .btn-success {
            background: #34C759;
            color: white;
        }

        .btn-success:active {
            background: #248A3D;
        }

        .btn-secondary {
            background: #8E8E93;
            color: white;
        }

        .btn-secondary:active {
            background: #636366;
        }

        .list-container {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 10px;
            margin: 15px 0;
            max-height: 400px;
            overflow-y: auto;
        }

        .list-item {
            background: white;
            padding: 15px;
            margin-bottom: 8px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e0e0e0;
        }

        .list-item:last-child {
            margin-bottom: 0;
        }

        .list-item .name {
            font-weight: 500;
            color: #333;
        }

        .list-item .price {
            color: #34C759;
            font-weight: 600;
        }

        .list-item .remove-btn {
            background: none;
            color: #FF3B30;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 18px;
            margin-left: 10px;
        }

        .checkbox-item {
            background: white;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid #e0e0e0;
        }

        .checkbox-item:active {
            background: #f0f0f0;
        }

        .checkbox-item.selected {
            background: #E3F2FD;
            border-color: #007AFF;
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 25px;
            gap: 10px;
        }

        .results-grid {
            display: grid;
            gap: 12px;
            margin: 15px 0;
        }

        .result-card {
            background: white;
            border: 1px solid #e0e0e0;
            padding: 20px;
            border-radius: 8px;
        }

        .result-card .name {
            font-size: 1.1em;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .result-card .amount {
            font-size: 1.8em;
            font-weight: 700;
            color: #007AFF;
        }

        .total-card {
            background: #007AFF;
            color: white;
            padding: 25px;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0;
        }

        .total-card .label {
            font-size: 1em;
            margin-bottom: 8px;
            opacity: 0.9;
        }

        .total-card .amount {
            font-size: 2.5em;
            font-weight: 700;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .count-badge {
            display: inline-block;
            background: #007AFF;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            margin-left: 8px;
            font-weight: 500;
        }

        .progress-bar {
            height: 3px;
            background: #e0e0e0;
            margin-bottom: 20px;
        }

        .progress-fill {
            height: 100%;
            background: #007AFF;
            transition: width 0.3s;
        }

        .pay-message {
            text-align: center;
            color: #FF3B30;
            font-size: 1.2em;
            font-weight: 600;
            margin: 20px 0;
        }

        .instruction {
            background: #f0f0f0;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 6px;
            color: #666;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .input-group {
                flex-direction: column;
            }

            .navigation {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: #999;
            font-size: 0.85em;
            border-top: 1px solid #e0e0e0;
            margin-top: 30px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Bill Splitter</h1>
            <p>Split bills fairly</p>
        </div>

        <div class="content">
            <!-- Progress Bar -->
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar" style="width: 0%"></div>
            </div>

            <!-- Step 1: Add Dishes -->
            <div id="step1" class="step active">
                <h2 class="step-header">Add Dishes <span class="count-badge" id="dishCount">0</span></h2>
                <div class="instruction">
                    Add each dish from your bill with its price
                </div>
                <div class="input-group">
                    <input type="text" id="dishName" placeholder="Dish name" autocomplete="off">
                    <input type="number" id="dishPrice" placeholder="Price" step="0.01" min="0" autocomplete="off">
                    <button class="btn btn-success" onclick="addDish()">Add</button>
                </div>
                <div class="list-container" id="dishList">
                    <div class="empty-state">No dishes yet</div>
                </div>
                <div class="navigation">
                    <button class="btn btn-secondary" onclick="resetApp()">Reset</button>
                    <button class="btn btn-primary" onclick="nextStep(2)">Next</button>
                </div>
            </div>

            <!-- Step 2: Add People -->
            <div id="step2" class="step">
                <h2 class="step-header">Add People <span class="count-badge" id="peopleCount">0</span></h2>
                <div class="instruction">
                    Add everyone who's sharing the bill
                </div>
                <div class="input-group">
                    <input type="text" id="personName" placeholder="Person's name" autocomplete="off">
                    <button class="btn btn-success" onclick="addPerson()">Add</button>
                </div>
                <div class="list-container" id="peopleList">
                    <div class="empty-state">No people yet</div>
                </div>
                <div class="navigation">
                    <button class="btn btn-secondary" onclick="previousStep(1)">Back</button>
                    <button class="btn btn-primary" onclick="nextStep(3)">Next</button>
                </div>
            </div>

            <!-- Step 3: Assign Orders -->
            <div id="step3" class="step">
                <h2 class="step-header">Assign Orders</h2>
                <div class="instruction">
                    Select which dishes each person ordered
                </div>
                <div id="assignmentContainer"></div>
                <div class="navigation">
                    <button class="btn btn-secondary" onclick="previousStep(2)">Back</button>
                    <button class="btn btn-primary" onclick="calculateBill()">Calculate</button>
                </div>
            </div>

            <!-- Step 4: Results -->
            <div id="step4" class="step">
                <h2 class="step-header">Results</h2>
                <div class="results-grid" id="resultsGrid"></div>
                <div class="total-card">
                    <div class="label">Total Bill</div>
                    <div class="amount" id="totalAmount">฿0.00</div>
                </div>
                <div class="pay-message">Please pay your share</div>
                <div class="navigation">
                    <button class="btn btn-secondary" onclick="resetApp()">Reset</button>
                    <button class="btn btn-success" onclick="downloadBill()">Download</button>
                    <button class="btn btn-primary" onclick="shareResults()">Share</button>
                </div>
            </div>

            <div class="footer">
                All calculations happen in your browser
            </div>
        </div>
    </div>

    <script>
        // Application state
        let currentStep = 1;
        let dishes = [];
        let people = [];
        let assignments = {};

        // Load from localStorage on page load
        window.addEventListener('load', () => {
            loadFromStorage();
        });

        // Save to localStorage
        function saveToStorage() {
            localStorage.setItem('billSplitter', JSON.stringify({
                dishes,
                people,
                assignments,
                currentStep
            }));
        }

        // Load from localStorage
        function loadFromStorage() {
            const saved = localStorage.getItem('billSplitter');
            if (saved) {
                const data = JSON.parse(saved);
                dishes = data.dishes || [];
                people = data.people || [];
                assignments = data.assignments || {};
                updateDishList();
                updatePeopleList();
            }
        }

        // Update progress bar
        function updateProgress() {
            const progress = ((currentStep - 1) / 3) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
        }

        // Add dish
        function addDish() {
            const nameInput = document.getElementById('dishName');
            const priceInput = document.getElementById('dishPrice');
            const name = nameInput.value.trim();
            const price = parseFloat(priceInput.value);

            if (!name || !price || price <= 0) {
                alert('Please enter a valid dish name and price');
                return;
            }

            if (dishes.some(d => d.name === name)) {
                alert('This dish has already been added');
                return;
            }

            dishes.push({ name, price });
            nameInput.value = '';
            priceInput.value = '';
            nameInput.focus();
            updateDishList();
            saveToStorage();
        }

        // Remove dish
        function removeDish(index) {
            const dish = dishes[index];
            if (confirm(`Remove "${dish.name}"?`)) {
                dishes.splice(index, 1);
                delete assignments[dish.name];
                updateDishList();
                saveToStorage();
            }
        }

        // Update dish list display
        function updateDishList() {
            const container = document.getElementById('dishList');
            document.getElementById('dishCount').textContent = dishes.length;

            if (dishes.length === 0) {
                container.innerHTML = '<div class="empty-state">No dishes yet</div>';
                return;
            }

            container.innerHTML = dishes.map((dish, index) => `
                <div class="list-item">
                    <div>
                        <span class="name">${dish.name}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span class="price">฿${dish.price.toFixed(2)}</span>
                        <button class="remove-btn" onclick="removeDish(${index})">×</button>
                    </div>
                </div>
            `).join('');
        }

        // Add person
        function addPerson() {
            const nameInput = document.getElementById('personName');
            const name = nameInput.value.trim();

            if (!name) {
                alert('Please enter a person\'s name');
                return;
            }

            if (people.includes(name)) {
                alert('This person has already been added');
                return;
            }

            people.push(name);
            nameInput.value = '';
            nameInput.focus();
            updatePeopleList();
            saveToStorage();
        }

        // Remove person
        function removePerson(index) {
            const person = people[index];
            if (confirm(`Remove "${person}"?`)) {
                people.splice(index, 1);
                // Remove from assignments
                for (let dish in assignments) {
                    assignments[dish] = assignments[dish].filter(p => p !== person);
                }
                updatePeopleList();
                saveToStorage();
            }
        }

        // Update people list display
        function updatePeopleList() {
            const container = document.getElementById('peopleList');
            document.getElementById('peopleCount').textContent = people.length;

            if (people.length === 0) {
                container.innerHTML = '<div class="empty-state">No people yet</div>';
                return;
            }

            container.innerHTML = people.map((person, index) => `
                <div class="list-item">
                    <span class="name">${person}</span>
                    <button class="remove-btn" onclick="removePerson(${index})">×</button>
                </div>
            `).join('');
        }

        // Build assignment UI
        function buildAssignmentUI() {
            const container = document.getElementById('assignmentContainer');
            
            container.innerHTML = people.map(person => {
                const personDishes = dishes.map(dish => {
                    const isChecked = assignments[dish.name] && assignments[dish.name].includes(person);
                    return `
                        <div class="checkbox-item ${isChecked ? 'selected' : ''}" onclick="toggleAssignment('${escapeHtml(dish.name)}', '${escapeHtml(person)}', this)">
                            <input type="checkbox" ${isChecked ? 'checked' : ''} onchange="event.stopPropagation(); toggleAssignment('${escapeHtml(dish.name)}', '${escapeHtml(person)}', this.parentElement)">
                            <span>${dish.name} - ฿${dish.price.toFixed(2)}</span>
                        </div>
                    `;
                }).join('');

                return `
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #333; margin-bottom: 12px; font-size: 1.1em;">${person}</h3>
                        <div class="list-container">
                            ${personDishes}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Toggle dish assignment
        function toggleAssignment(dishName, personName, element) {
            if (!assignments[dishName]) {
                assignments[dishName] = [];
            }

            const index = assignments[dishName].indexOf(personName);
            if (index > -1) {
                assignments[dishName].splice(index, 1);
                element.classList.remove('selected');
                element.querySelector('input').checked = false;
            } else {
                assignments[dishName].push(personName);
                element.classList.add('selected');
                element.querySelector('input').checked = true;
            }
            saveToStorage();
        }

        // Calculate bill
        function calculateBill() {
            // Initialize totals
            const personTotals = {};
            people.forEach(person => {
                personTotals[person] = 0;
            });

            // Calculate shared costs
            dishes.forEach(dish => {
                const eaters = assignments[dish.name] || [];
                if (eaters.length > 0) {
                    const pricePerPerson = dish.price / eaters.length;
                    eaters.forEach(eater => {
                        if (personTotals.hasOwnProperty(eater)) {
                            personTotals[eater] += pricePerPerson;
                        }
                    });
                }
            });

            // Calculate total bill
            const totalBill = dishes.reduce((sum, dish) => sum + dish.price, 0);

            // Display results
            displayResults(personTotals, totalBill);
            nextStep(4);
        }

        // Display results
        function displayResults(personTotals, totalBill) {
            const resultsGrid = document.getElementById('resultsGrid');
            
            resultsGrid.innerHTML = Object.entries(personTotals).map(([name, amount]) => `
                <div class="result-card">
                    <div class="name">${name}</div>
                    <div class="amount">฿${amount.toFixed(2)}</div>
                </div>
            `).join('');

            document.getElementById('totalAmount').textContent = `฿${totalBill.toFixed(2)}`;
        }

        // Download bill as text file
        function downloadBill() {
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            
            let content = "===== Bill Summary =====\n";
            content += `Created: ${new Date().toLocaleString()}\n\n`;
            
            people.forEach(person => {
                const total = calculatePersonTotal(person);
                content += `${person}: ฿${total.toFixed(2)}\n`;
            });
            
            const totalBill = dishes.reduce((sum, dish) => sum + dish.price, 0);
            content += `\nTotal Bill: ฿${totalBill.toFixed(2)}\n`;
            content += "=========================\n\n";
            content += "Dish Details:\n";
            dishes.forEach(dish => {
                const eaters = assignments[dish.name] || [];
                content += `- ${dish.name}: ฿${dish.price.toFixed(2)} (shared by: ${eaters.join(', ') || 'nobody'})\n`;
            });

            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bill_${timestamp}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Share results
        async function shareResults() {
            let text = "Bill Summary\n\n";
            
            people.forEach(person => {
                const total = calculatePersonTotal(person);
                text += `${person}: ฿${total.toFixed(2)}\n`;
            });
            
            const totalBill = dishes.reduce((sum, dish) => sum + dish.price, 0);
            text += `\nTotal: ฿${totalBill.toFixed(2)}`;

            // Try native share API first (mobile)
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'Bill Summary',
                        text: text
                    });
                    return;
                } catch (err) {
                    // User cancelled or share failed, fall back to copy
                    if (err.name !== 'AbortError') {
                        console.log('Share failed, copying to clipboard instead');
                    } else {
                        return; // User cancelled, do nothing
                    }
                }
            }
            
            // Fallback to clipboard
            copyToClipboard(text);
        }

        // Copy to clipboard with better browser support
        function copyToClipboard(text) {
            // Try modern clipboard API first
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text)
                    .then(() => {
                        alert('✅ Copied to clipboard!');
                    })
                    .catch(() => {
                        // Fallback to old method
                        fallbackCopy(text);
                    });
            } else {
                // Fallback for older browsers
                fallbackCopy(text);
            }
        }

        // Fallback copy method for older browsers
        function fallbackCopy(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.left = '-999999px';
            textarea.style.top = '-999999px';
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    alert('✅ Copied to clipboard!');
                } else {
                    alert('❌ Copy failed. Please try again.');
                }
            } catch (err) {
                alert('❌ Copy not supported. Please screenshot the results.');
            }
            
            document.body.removeChild(textarea);
        }

        // Calculate person's total
        function calculatePersonTotal(person) {
            let total = 0;
            dishes.forEach(dish => {
                const eaters = assignments[dish.name] || [];
                if (eaters.includes(person)) {
                    total += dish.price / eaters.length;
                }
            });
            return total;
        }

        // Navigation
        function nextStep(step) {
            if (step === 2 && dishes.length === 0) {
                alert('Please add at least one dish');
                return;
            }
            if (step === 3 && people.length === 0) {
                alert('Please add at least one person');
                return;
            }
            if (step === 3) {
                buildAssignmentUI();
            }

            document.getElementById(`step${currentStep}`).classList.remove('active');
            currentStep = step;
            document.getElementById(`step${currentStep}`).classList.add('active');
            updateProgress();
            saveToStorage();
            window.scrollTo(0, 0);
        }

        function previousStep(step) {
            document.getElementById(`step${currentStep}`).classList.remove('active');
            currentStep = step;
            document.getElementById(`step${currentStep}`).classList.add('active');
            updateProgress();
            saveToStorage();
            window.scrollTo(0, 0);
        }

        // Reset app
        function resetApp() {
            if (confirm('Start over? All data will be lost.')) {
                // Clear all data
                dishes = [];
                people = [];
                assignments = {};
                currentStep = 1;
                
                // Clear localStorage
                localStorage.removeItem('billSplitter');
                
                // Reset all displays
                updateDishList();
                updatePeopleList();
                
                // Clear input fields
                document.getElementById('dishName').value = '';
                document.getElementById('dishPrice').value = '';
                document.getElementById('personName').value = '';
                
                // Reset to step 1
                document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
                document.getElementById('step1').classList.add('active');
                
                // Reset progress bar
                updateProgress();
                
                // Scroll to top
                window.scrollTo(0, 0);
            }
        }

        // Enter key support
        document.getElementById('dishName').addEventListener('keypress', e => {
            if (e.key === 'Enter') addDish();
        });
        document.getElementById('dishPrice').addEventListener('keypress', e => {
            if (e.key === 'Enter') addDish();
        });
        document.getElementById('personName').addEventListener('keypress', e => {
            if (e.key === 'Enter') addPerson();
        });

        // Initialize
        updateProgress();
    </script>
</body>
</html>